<ion-content class="ion-padding">
  <div
    class="flex flex-col md:grid md:grid-cols-[minmax(0,_1fr)_16rem] gap-4 md:gap-6 max-w-[var(--app-max)] mx-auto items-start">
    <!-- BOARD + Clocks -->
    <div class="w-full md:col-start-1 md:row-start-1">
      <div class="flex flex-col items-center gap-2">
        <!-- Top player bar (Opponent) swaps color with flip -->
        <div class="player-bar max-w-[min(92vw,80vh)] w-full mx-auto" [ngClass]="flipped() ? 'white' : 'black'">
          <div class="player-meta">
            <!-- <div class="avatar" aria-hidden="true"></div> -->
            <div class="name">
              <!-- Top bar name: color = flipped() ? 'w' : 'b' -->
              <ng-container *ngIf="flipped(); else topBlack">
                <input *ngIf="editingWhite(); else topWhiteView" class="name-input" [ngModel]="whiteName()"
                  (ngModelChange)="whiteName.set($event)" (blur)="endEdit('w')" (keyup.enter)="endEdit('w')" />
                <ng-template #topWhiteView>
                  <button type="button" class="name-button" title="Edit name" aria-label="Edit white name"
                    (click)="beginEdit('w')">
                    {{ whiteName() }}
                    <svg class="inline-block ml-1 align-middle opacity-70" xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9" />
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                  </button>
                </ng-template>
              </ng-container>
              <ng-template #topBlack>
                <input *ngIf="editingBlack(); else topBlackView" class="name-input" [ngModel]="blackName()"
                  (ngModelChange)="blackName.set($event)" (blur)="endEdit('b')" (keyup.enter)="endEdit('b')" />
                <ng-template #topBlackView>
                  <button type="button" class="name-button" title="Edit name" aria-label="Edit black name"
                    (click)="beginEdit('b')">
                    {{ blackName() }}
                    <svg class="inline-block ml-1 align-middle opacity-70" xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9" />
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                  </button>
                </ng-template>
              </ng-template>
            </div>
          </div>
          <div class="clock" [ngClass]="[
              (flipped() ? 'clock-white' : 'clock-black'),
              (game.turn() === (flipped() ? 'w' : 'b') && running()) ? 'active' : '',
              ((flipped() ? whiteTimeMs() : blackTimeMs()) <= 10000) ? 'low' : ''
            ]">
            {{ formatTime(flipped() ? whiteTimeMs() : blackTimeMs()) }}
          </div>
        </div>

        <div #board
          class="chessboard relative grid grid-cols-8 grid-rows-8 aspect-square max-w-[min(92vw,80vh)] mx-auto rounded-2xl overflow-hidden shadow-xl select-none">
          <button *ngFor="let sq of boardSquares(); trackBy: trackSquare" (click)="onSquareClick(sq.name)"
            class="relative flex items-center justify-center" [ngClass]="[getSquareColorClass(sq)]"
            [attr.data-square]="sq.name">
            <img *ngIf="sq.piece" class="piece-svg relative z-10" [src]="pieceImageSrc(sq)" [attr.draggable]="false"
              alt="" (pointerdown)="onPiecePointerDown(sq.name, $event)" (mousedown)="onMouseDownPiece(sq.name, $event)" />

            <!-- coordinate labels -->
            <span *ngIf="showFileLabel(sq.name)"
              class="coord-label pointer-events-none absolute bottom-0.5 right-1 text-[10px] sm:text-[11px] font-medium z-20">
              {{ sq.name[0] }}
            </span>
            <span *ngIf="showRankLabel(sq.name)"
              class="coord-label pointer-events-none absolute top-0.5 left-1 text-[10px] sm:text-[11px] font-medium z-20">
              {{ sq.name[1] }}
            </span>

            <!-- capture target large dot (same style as dot, just larger) -->
            <div *ngIf="isCaptureTarget(sq.name)"
              class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
              <div class="rounded-full opacity-80 bg-black/30 w-9 h-9 md:w-12 md:h-12"></div>
            </div>

            <!-- legal target dot -->
            <div *ngIf="isLegalTarget(sq.name)"
              class="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
              <div class="w-5 h-5 md:w-6 md:h-6 rounded-full opacity-80 bg-black/30"></div>
            </div>

            <!-- last move highlight (inner border to avoid clipping) -->
            <div *ngIf="isLastMoveSquare(sq.name)"
              class="absolute inset-[2px] border-2 border-blue-500 pointer-events-none"></div>

            <!-- selection highlight (inner border to avoid clipping) -->
            <div *ngIf="sq.name === selected()"
              class="absolute inset-[2px] border-2 border-yellow-400 pointer-events-none"></div>

            <!-- king in check highlight -->
            <div *ngIf="isCheckedKingSquare(sq.name)" class="absolute inset-0 pointer-events-none z-0">
              <div [ngClass]="['w-full h-full bg-red-500/60', checkFlash() ? 'animate-pulse' : '']"></div>
            </div>
          </button>
          <!-- Promotion overlay: scoped to board only -->
          <div *ngIf="promotion().ask" class="absolute inset-0 bg-black/40 flex items-center justify-center z-20">
            <div class="bg-white dark:bg-zinc-800 rounded-xl p-4 flex gap-4 shadow-lg">
              <button *ngFor="let piece of promotionPieces"
                class="w-12 h-12 md:w-14 md:h-14 flex items-center justify-center rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition"
                (click)="promote(piece)">
                <img class="piece-svg" [src]="promotionImageSrc(piece, promotion().color)" alt="" />
              </button>
            </div>
          </div>
          <!-- Confetti canvas overlay (renders on win) -->
          <canvas #confettiCanvas class="confetti-canvas absolute inset-0 pointer-events-none z-30"></canvas>
        </div>

        <!-- Bottom player bar (You) swaps color with flip -->
        <div class="player-bar max-w-[min(92vw,80vh)] w-full mx-auto" [ngClass]="flipped() ? 'black' : 'white'">
          <div class="player-meta">
            <!-- <div class="avatar" aria-hidden="true"></div> -->
            <div class="name">
              <!-- Bottom bar name: color = flipped() ? 'b' : 'w' -->
              <ng-container *ngIf="flipped(); else bottomWhite">
                <input *ngIf="editingBlack(); else bottomBlackView" class="name-input" [ngModel]="blackName()"
                  (ngModelChange)="blackName.set($event)" (blur)="endEdit('b')" (keyup.enter)="endEdit('b')" />
                <ng-template #bottomBlackView>
                  <button type="button" class="name-button" title="Edit name" aria-label="Edit black name"
                    (click)="beginEdit('b')">
                    {{ blackName() }}
                    <svg class="inline-block ml-1 align-middle opacity-70" xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9" />
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                  </button>
                </ng-template>
              </ng-container>
              <ng-template #bottomWhite>
                <input *ngIf="editingWhite(); else bottomWhiteView" class="name-input" [ngModel]="whiteName()"
                  (ngModelChange)="whiteName.set($event)" (blur)="endEdit('w')" (keyup.enter)="endEdit('w')" />
                <ng-template #bottomWhiteView>
                  <button type="button" class="name-button" title="Edit name" aria-label="Edit white name"
                    (click)="beginEdit('w')">
                    {{ whiteName() }}
                    <svg class="inline-block ml-1 align-middle opacity-70" xmlns="http://www.w3.org/2000/svg" width="16"
                      height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9" />
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                  </button>
                </ng-template>
              </ng-template>
            </div>
          </div>
          <div class="clock" [ngClass]="[
              (flipped() ? 'clock-black' : 'clock-white'),
              (game.turn() === (flipped() ? 'b' : 'w') && running()) ? 'active' : '',
              ((flipped() ? blackTimeMs() : whiteTimeMs()) <= 10000) ? 'low' : ''
            ]">
            {{ formatTime(flipped() ? blackTimeMs() : whiteTimeMs()) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Controls strip under the board -->
    <div class="w-full flex items-center justify-center md:col-start-1 md:row-start-2">
      <div
        class="flex gap-2 md:gap-3 bg-white/70 dark:bg-zinc-800/70 backdrop-blur rounded-xl px-2.5 py-2 shadow text-zinc-700 dark:text-zinc-200">
        <!-- Undo (rotate-ccw) -->
        <button
          class="w-10 h-10 md:w-10 md:h-10 flex items-center justify-center rounded-lg transition outline-none focus:ring-2 focus:ring-blue-400/50 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent hover:bg-zinc-200 dark:hover:bg-zinc-700"
          (click)="undo()" [disabled]="!canUndo()" title="Undo" aria-label="Undo">
          <!-- lucide: rotate-ccw -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-undo-icon lucide-undo">
            <path d="M3 7v6h6" />
            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
          </svg>
        </button>
        <!-- Redo (rotate-cw) -->
        <button
          class="w-10 h-10 md:w-10 md:h-10 flex items-center justify-center rounded-lg transition outline-none focus:ring-2 focus:ring-blue-400/50 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent hover:bg-zinc-200 dark:hover:bg-zinc-700"
          (click)="redo()" [disabled]="!canRedo()" title="Redo" aria-label="Redo">
          <!-- lucide: rotate-cw -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-redo-icon lucide-redo">
            <path d="M21 7v6h-6" />
            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7" />
          </svg>
        </button>
        <!-- Flip board -->
        <button
          class="w-10 h-10 md:w-10 md:h-10 flex items-center justify-center rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition outline-none focus:ring-2 focus:ring-blue-400/50"
          (click)="flip()" title="Flip" aria-label="Flip Board">
          <!-- lucide: flip-horizontal-2 -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-flip-vertical2-icon lucide-flip-vertical-2">
            <path d="m17 3-5 5-5-5h10" />
            <path d="m17 21-5-5-5 5h10" />
            <path d="M4 12H2" />
            <path d="M10 12H8" />
            <path d="M16 12h-2" />
            <path d="M22 12h-2" />
          </svg>
        </button>
        <!-- New game -->
        <button
          class="w-10 h-10 md:w-10 md:h-10 flex items-center justify-center rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition outline-none focus:ring-2 focus:ring-blue-400/50"
          (click)="reset()" title="New Game" aria-label="New Game">
          <!-- lucide: refresh-ccw -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 block">
            <path vector-effect="non-scaling-stroke" d="M3 2v6h6" />
            <path vector-effect="non-scaling-stroke" d="M3 13a9 9 0 1 0 3-7.7L3 8" />
          </svg>
        </button>
        <!-- Sound toggle -->
        <button
          class="w-10 h-10 md:w-10 md:h-10 flex items-center justify-center rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition outline-none focus:ring-2 focus:ring-blue-400/50"
          (click)="toggleSound()" [title]="soundOn() ? 'Sound: On' : 'Sound: Off'" aria-label="Toggle Sound">
          <ng-container *ngIf="soundOn(); else soundOffIcon">
            <!-- lucide: volume-2 -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 5 6 9H2v6h4l5 4V5Z" />
              <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
              <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
            </svg>
          </ng-container>
          <ng-template #soundOffIcon>
            <!-- lucide: volume-x -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 5 6 9H2v6h4l5 4V5Z" />
              <path d="m22 9-6 6" />
              <path d="m16 9 6 6" />
            </svg>
          </ng-template>
        </button>
      </div>
    </div>

    <div class="w-full md:w-72 lg:w-80 xl:w-64 space-y-3 md:col-start-2 md:row-start-1 md:row-span-2">
      <!-- Time Control Card -->
      <ion-card class="bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-white/20 dark:border-zinc-700/50">
        <ion-card-header class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 p-3">
          <ion-card-title class="text-lg font-bold text-white flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Time Control
          </ion-card-title>
        </ion-card-header>
        <ion-card-content class="p-3 space-y-3">
          <div class="text-sm text-zinc-600 dark:text-zinc-300">
            Current: {{ (baseMs()/60000) | number:'1.0-0' }}+{{ (incrementMs()/1000) | number:'1.0-0' }}
          </div>
          <div class="flex gap-2">
            <button 
              (click)="startClocks()" 
              [disabled]="running()" 
              class="px-4 py-2 rounded-full bg-blue-500 text-white font-medium text-sm md:text-base transition-all duration-300 hover:bg-blue-600 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:bg-blue-500"
              [class.transform]="!running()"
              [class.hover:scale-105]="!running()"
            >
              Start
            </button>
            <button 
              (click)="pauseClocks()" 
              [disabled]="!running()"
              class="px-4 py-2 rounded-full bg-yellow-500 text-white font-medium text-sm md:text-base transition-all duration-300 hover:bg-yellow-600 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:bg-yellow-500"
              [class.transform]="running()"
              [class.hover:scale-105]="running()"
            >
              Pause
            </button>
          </div>
          <div class="mt-2">
            <button 
              (click)="toggleTimePicker()"
              class="px-4 py-2 rounded-full border-2 border-blue-500 text-blue-500 font-medium text-sm md:text-base transition-all duration-300 hover:bg-blue-50 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 dark:hover:bg-blue-900/20 dark:text-blue-400 dark:border-blue-400"
            >
              Select Time
            </button>
          </div>
          <div *ngIf="timePickerOpen()" class="tc-picker">
            <div class="tc-section">
              <div class="tc-title">üöÄ Bullet</div>
              <div class="tc-grid">
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(1,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(1,0)
                }" 
                (click)="pickPreset(1,0)"
              >
                1 min
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(1,1),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(1,1)
                }" 
                (click)="pickPreset(1,1)"
              >
                1 | 1
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(2,1),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(2,1)
                }" 
                (click)="pickPreset(2,1)"
              >
                2 | 1
              </button>
              </div>
            </div>
            <div class="tc-section">
              <div class="tc-title">‚ö° Blitz</div>
              <div class="tc-grid">
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(3,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(3,0)
                }" 
                (click)="pickPreset(3,0)"
              >
                3 min
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(3,2),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(3,2)
                }" 
                (click)="pickPreset(3,2)"
              >
                3 | 2
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(5,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(5,0)
                }" 
                (click)="pickPreset(5,0)"
              >
                5 min
              </button>
              </div>
            </div>
            <div class="tc-section">
              <div class="tc-title">üïò Rapid</div>
              <div class="tc-grid">
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(10,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(10,0)
                }" 
                (click)="pickPreset(10,0)"
              >
                10 min
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(15,10),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(15,10)
                }" 
                (click)="pickPreset(15,10)"
              >
                15 | 10
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(30,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(30,0)
                }" 
                (click)="pickPreset(30,0)"
              >
                30 min
              </button>
              </div>
            </div>
            <div class="tc-section">
              <div class="tc-title">üåû Classical</div>
              <div class="tc-grid">
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(45,45),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(45,45)
                }" 
                (click)="pickPreset(45,45)"
              >
                45 | 45
              </button>
                <button 
                class="tc-pill transition-all duration-200 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/30 dark:hover:text-blue-300" 
                [ngClass]="{
                  'bg-blue-500 text-white hover:bg-blue-600 hover:text-white': isPresetActive(60,0),
                  'bg-white/80 text-zinc-700 dark:bg-zinc-700/50 dark:text-zinc-200': !isPresetActive(60,0)
                }" 
                (click)="pickPreset(60,0)"
              >
                60 min
              </button>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-white/20 dark:border-zinc-700/50">
        <ion-card-header class="bg-gradient-to-r from-emerald-500 to-emerald-600 dark:from-emerald-600 dark:to-emerald-700 p-3">
          <ion-card-title class="text-lg font-bold text-white flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 16v-4"></path>
              <path d="M12 8h.01"></path>
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
            Game Info
          </ion-card-title>
        </ion-card-header>
        <ion-card-content class="p-3">
          <div class="space-y-2.5">
            <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-zinc-700/30 rounded-lg">
              <span class="text-sm font-medium text-zinc-600 dark:text-zinc-300">Current Turn</span>
              <span class="px-3 py-1 rounded-full text-sm font-medium" [ngClass]="game.turn() === 'w' ? 'bg-white text-zinc-900' : 'bg-zinc-900 text-white'">
                {{ game.turn() === 'w' ? 'White' : 'Black' }}
              </span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white/50 dark:bg-zinc-700/30 rounded-lg">
              <span class="text-sm font-medium text-zinc-600 dark:text-zinc-300">Move Count</span>
              <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                {{ game.history().length }}
              </span>
            </div>
          </div>
          <button
            (click)="copyFEN()"
            title="Copy FEN" 
            aria-label="Copy FEN"
            class="w-full mt-4 px-4 py-2 rounded-full bg-blue-500 text-white font-medium text-sm md:text-base transition-all duration-300 hover:bg-blue-600 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 active:scale-95 flex items-center justify-center gap-2"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
              <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
              <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
            </svg>
            Copy FEN
          </button>
        </ion-card-content>
      </ion-card>

      <ion-card class="bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-white/20 dark:border-zinc-700/50">
        <ion-card-header class="bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-600 dark:to-purple-700 p-3">
          <ion-card-title class="text-lg font-bold text-white flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            FEN Import
          </ion-card-title>
        </ion-card-header>
        <ion-card-content class="p-3">
          <ion-item class="rounded-lg overflow-hidden mb-3 bg-white/50 dark:bg-zinc-700/50 border border-zinc-200 dark:border-zinc-600 transition-colors focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-200 dark:focus-within:ring-blue-900/50">
            <ion-input label="FEN" labelPlacement="floating" [(ngModel)]="fenInput"
              placeholder="Paste FEN here"></ion-input>
          </ion-item>
          <button 
            (click)="loadFEN(fenInput)"
            class="w-full mt-4 px-4 py-2 rounded-full bg-green-500 text-white font-medium text-sm md:text-base transition-all duration-300 hover:bg-green-600 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-50 active:scale-95"
          >
            Load FEN
          </button>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Game Over Modal -->
    <div *ngIf="gameOver()" class="fixed inset-0 z-50 flex items-center justify-center">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative mx-4 w-full max-w-sm rounded-2xl bg-zinc-800 text-white shadow-2xl p-4 sm:p-5">
        <button aria-label="Close" (click)="dismissGameOver()"
          class="absolute top-2.5 right-2.5 text-zinc-300 hover:text-white">
          ‚úï
        </button>
        <div class="flex items-start gap-3">
          <div class="text-yellow-400 text-3xl">üèÜ</div>
          <div>
            <div class="text-xl font-extrabold leading-6">
              <ng-container *ngIf="gameOver()?.winner; else drawTitle">
                {{ winnerDisplay() }} Won!
              </ng-container>
              <ng-template #drawTitle>Draw</ng-template>
            </div>
            <div class="text-sm text-zinc-300">{{ gameOver()?.message }}</div>
          </div>
        </div>
        <div class="mt-4">
          <button 
            (click)="reset()"
            class="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold text-base transition-all duration-300 hover:from-green-600 hover:to-emerald-700 hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-50 active:scale-95 transform hover:shadow-lg"
          >
            New Game
          </button>
        </div>
      </div>
    </div>
  </div>
</ion-content>